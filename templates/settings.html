{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}

<div class="settings-container">
    <div class="page-header">
        <h1>‚öôÔ∏è Settings</h1>
        <p>Configure your portfolio generator preferences and system settings</p>
    </div>

    {% if settings %}
    <form method="post" action="/settings/update" class="settings-form">
        
        <!-- Storage & File Management -->
        {% if 'storage' in settings %}
        <div class="section">
            <h2>üìÇ Storage & File Management</h2>
            <p>Configure how files are stored, processed, and managed</p>
            
            <div class="settings-grid">
                {% for key, setting in settings.storage.items() %}
                <div class="setting-item">
                    <label for="{{ key }}">{{ setting.description }}</label>
                    {% if setting.type == 'boolean' %}
                        <div class="toggle-wrapper">
                            <input type="checkbox" id="{{ key }}" name="{{ key }}" 
                                   {% if setting.value %}checked{% endif %} class="toggle-input">
                            <label for="{{ key }}" class="toggle-label"></label>
                        </div>
                    {% elif setting.type == 'integer' %}
                        <input type="number" id="{{ key }}" name="{{ key }}" 
                               value="{{ setting.value }}" min="0" class="form-control">
                    {% else %}
                        <input type="text" id="{{ key }}" name="{{ key }}" 
                               value="{{ setting.value }}" class="form-control">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Image Processing -->
        {% if 'image_processing' in settings %}
        <div class="section">
            <h2>üñºÔ∏è Image Processing</h2>
            <p>Control how images are processed and optimized</p>
            
            <div class="settings-grid">
                {% for key, setting in settings.image_processing.items() %}
                <div class="setting-item">
                    <label for="{{ key }}">{{ setting.description }}</label>
                    {% if setting.type == 'boolean' %}
                        <div class="toggle-wrapper">
                            <input type="checkbox" id="{{ key }}" name="{{ key }}" 
                                   {% if setting.value %}checked{% endif %} class="toggle-input">
                            <label for="{{ key }}" class="toggle-label"></label>
                        </div>
                    {% elif setting.type == 'integer' %}
                        <input type="number" id="{{ key }}" name="{{ key }}" 
                               value="{{ setting.value }}" min="0" class="form-control">
                    {% else %}
                        <input type="text" id="{{ key }}" name="{{ key }}" 
                               value="{{ setting.value }}" class="form-control">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Portfolio Generation -->
        {% if 'portfolio' in settings %}
        <div class="section">
            <h2>üåê Portfolio Generation</h2>
            <p>Configure default settings for generated portfolio websites</p>
            
            <div class="settings-grid">
                {% for key, setting in settings.portfolio.items() %}
                <div class="setting-item">
                    <label for="{{ key }}">{{ setting.description }}</label>
                    {% if setting.type == 'boolean' %}
                        <div class="toggle-wrapper">
                            <input type="checkbox" id="{{ key }}" name="{{ key }}" 
                                   {% if setting.value %}checked{% endif %} class="toggle-input">
                            <label for="{{ key }}" class="toggle-label"></label>
                        </div>
                    {% elif setting.type == 'integer' %}
                        <input type="number" id="{{ key }}" name="{{ key }}" 
                               value="{{ setting.value }}" min="0" max="100" class="form-control">
                    {% elif setting.type == 'text' %}
                        <textarea id="{{ key }}" name="{{ key }}" rows="3" 
                                  class="form-control">{{ setting.value }}</textarea>
                    {% else %}
                        <input type="text" id="{{ key }}" name="{{ key }}" 
                               value="{{ setting.value }}" class="form-control">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Save Button -->
        <div class="btn-group">
            <button type="reset" class="btn btn-secondary">
                <i class="icon">‚Ü∫</i>
                Reset Form
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="icon">üíæ</i>
                Save Settings
            </button>
        </div>
    </form>
    {% endif %}

    <!-- Database Management -->
    <div class="section">
        <h2>üóÑÔ∏è Database Management</h2>
        <p>Manage your image database and galleries.</p>
        
        <div class="danger-zone">
            <h3>‚ö†Ô∏è Danger Zone</h3>
            <p>These actions cannot be undone. Please proceed with caution.</p>
            
            <button type="button" onclick="showResetConfirmation()" class="btn btn-danger">
                <i class="icon">üóëÔ∏è</i>
                Reset Image Database
            </button>
        </div>
    </div>
</div>

{% if message %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof showToast === 'function') {
            showToast({{ message|tojson }}, 'success');
        }
    });
</script>
{% endif %}

<script>
function showResetConfirmation() {
    console.log('showResetConfirmation called');
    
    // Try modal system if available
    if (typeof window.ModalSystem !== 'undefined' && window.ModalSystem.show) {
        console.log('Using ModalSystem');
        window.ModalSystem.show({
            type: 'warning',
            title: '‚ö†Ô∏è Reset Image Database',
            body: `
                <p><strong>This action will permanently delete:</strong></p>
                <ul>
                    <li>All galleries and their metadata</li>
                    <li>All uploaded images and thumbnails</li>
                    <li>All generated static sites</li>
                    <li>All database records</li>
                </ul>
                <p><strong>This action cannot be undone!</strong></p>
                <p>Are you absolutely sure you want to continue?</p>
            `,
            confirmText: 'Reset Database',
            confirmClass: 'btn-danger',
            confirmIcon: 'üóëÔ∏è',
            onConfirm: () => {
                // Create and submit form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/settings/reset';
                document.body.appendChild(form);
                form.submit();
            }
        });
    } else {
        // Simple fallback that always works
        console.log('ModalSystem not available, using confirm');
        if (confirm('Are you sure you want to reset the image database?\n\nThis will permanently delete:\n- All galleries and their metadata\n- All uploaded images and thumbnails\n- All generated static sites\n- All database records\n\nThis action cannot be undone!')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/settings/reset';
            document.body.appendChild(form);
            form.submit();
        }
    }
}
</script>
{% endblock %}
